"use client";
import React, { useState } from "react";
import { couponVerification } from "~/app/actions/coupons-action";
import { ICoupon } from "~/models/coupon.model";
import { useCartStore } from "~/store/cart.store";

function ApplyCoupon({ appliedCoupon }: { appliedCoupon: string | undefined }) {
  const { cart, setCoupon, removeCoupon } = useCartStore((state) => ({
    setCoupon: state.setCoupon,
    removeCoupon: state.removeCoupon,
    cart: state.cart,
  }));
  const [couponCode, setCouponCode] = useState<string>("");
  const [couponInfo, setCouponInfo] = useState<{
    coupon: ICoupon | undefined;
    error: string | undefined;
  }>({
    coupon: undefined,
    error: undefined,
  });

  const [showInputFiled, setShowInputFiled] = useState<boolean>(true);

  function handleCouponVerification() {
    couponVerification(couponCode).then((resp) => {
      if (resp.coupon) {
     
        setCouponInfo({ coupon: resp.coupon, error: undefined });
        setShowInputFiled(false);

        setCoupon(resp.coupon);
      } else if (resp.error) {
        console.log("error is", resp.error);
        setCouponInfo({ coupon: undefined, error: resp.error });
        setShowInputFiled(true);
      }
    });
  }

  function handleCouponChangeHandler() {
    setShowInputFiled(true);
    removeCoupon();
  }
  return (
    <>
      {!appliedCoupon && showInputFiled ? (
        <div className="mb-4 flex w-full items-center justify-between rounded border border-primary/15 bg-white px-4 py-2 shadow-sm">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            className="lg:h-9 lg:w-9"
          >
            <g clip-path="url(#clip0_801_3480)">
              <path
                d="M22.4039 12.3109C22.3074 12.1134 22.3074 11.8868 22.4039 11.6892L23.299 9.85808C23.7974 8.8385 23.4025 7.62328 22.4001 7.09139L20.5996 6.13608C20.4054 6.03305 20.2722 5.84968 20.2342 5.63316L19.8821 3.62557C19.686 2.50779 18.652 1.75667 17.5286 1.91562L15.5105 2.20109C15.2927 2.23184 15.0773 2.16181 14.9193 2.00895L13.4544 0.591834C12.6387 -0.197255 11.3609 -0.197302 10.5453 0.591834L9.08035 2.00909C8.92229 2.162 8.7069 2.23189 8.48912 2.20123L6.47102 1.91576C5.3472 1.75672 4.31361 2.50793 4.11753 3.62571L3.76541 5.63321C3.7274 5.84977 3.59422 6.0331 3.40002 6.13618L1.59956 7.09148C0.597101 7.62332 0.202228 8.83865 0.700601 9.85822L1.59567 11.6893C1.69224 11.8869 1.69224 12.1135 1.59567 12.311L0.700554 14.1421C0.202182 15.1617 0.597054 16.3769 1.59952 16.9088L3.39998 17.8641C3.59422 17.9672 3.7274 18.1505 3.76541 18.3671L4.11753 20.3747C4.29603 21.3922 5.16856 22.1058 6.17135 22.1057C6.27011 22.1057 6.37033 22.0988 6.47107 22.0846L8.48917 21.7991C8.7068 21.7682 8.92233 21.8384 9.0804 21.9912L10.5453 23.4083C10.9532 23.8029 11.4764 24.0002 11.9998 24.0001C12.5231 24.0001 13.0466 23.8028 13.4543 23.4083L14.9193 21.9912C15.0773 21.8384 15.2927 21.7685 15.5105 21.7991L17.5286 22.0846C18.6525 22.2436 19.686 21.4924 19.8821 20.3746L20.2342 18.3671C20.2723 18.1505 20.4054 17.9672 20.5996 17.8641L22.4001 16.9088C23.4025 16.377 23.7974 15.1617 23.299 14.1421L22.4039 12.3109ZM21.7513 15.686L19.9508 16.6413C19.3768 16.946 18.9831 17.4877 18.8708 18.1279L18.5187 20.1354C18.4524 20.5136 18.1027 20.7676 17.7225 20.7139L15.7044 20.4285C15.0608 20.3373 14.4239 20.5444 13.9568 20.9963L12.4919 22.4133C12.216 22.6802 11.7837 22.6802 11.5077 22.4133L10.0428 20.9962C9.648 20.6143 9.13191 20.4074 8.59313 20.4074C8.49442 20.4074 8.3949 20.4143 8.29524 20.4284L6.27715 20.7139C5.89718 20.7676 5.54726 20.5135 5.48089 20.1354L5.12872 18.1278C5.0164 17.4876 4.62275 16.9458 4.04867 16.6413L2.24822 15.686C1.90903 15.506 1.77544 15.0949 1.94405 14.7499L2.83917 12.9188C3.12454 12.3349 3.12454 11.6652 2.83917 11.0814L1.94405 9.25021C1.77544 8.90526 1.90903 8.49412 2.24822 8.31416L4.04867 7.35886C4.6227 7.05422 5.0164 6.51244 5.12867 5.87232L5.48079 3.86477C5.54717 3.48658 5.89676 3.23252 6.27705 3.28624L8.29515 3.57171C8.93851 3.66279 9.57558 3.45574 10.0427 3.00391L11.5076 1.5868C11.7835 1.31989 12.2158 1.31989 12.4918 1.5868L13.9567 3.00391C14.4238 3.45579 15.0608 3.66279 15.7043 3.57171L17.7224 3.28624C18.1024 3.23248 18.4523 3.48658 18.5186 3.86477L18.8707 5.87237C18.9831 6.51249 19.3767 7.05431 19.9508 7.35886L21.7512 8.31416C22.0904 8.49412 22.224 8.90526 22.0554 9.25021L21.1603 11.0813C20.8749 11.6651 20.8749 12.3349 21.1603 12.9187L22.0554 14.7498C22.2241 15.0949 22.0905 15.5061 21.7513 15.686Z"
                fill="#2AA952"
              />
              <path
                d="M17.0571 6.94294C16.7869 6.67266 16.3486 6.67266 16.0783 6.94294L6.94294 16.0784C6.67266 16.3486 6.67266 16.7869 6.94294 17.0571C7.07808 17.1923 7.25522 17.2599 7.43232 17.2599C7.60941 17.2599 7.7866 17.1923 7.92169 17.0571L17.0571 7.92178C17.3274 7.65146 17.3274 7.21327 17.0571 6.94294Z"
                fill="#2AA952"
              />
              <path
                d="M9.23111 5.77148C7.83181 5.77148 6.69336 6.90993 6.69336 8.30924C6.69336 9.70854 7.83181 10.847 9.23111 10.847C10.6304 10.847 11.7689 9.70854 11.7689 8.30924C11.7689 6.90993 10.6304 5.77148 9.23111 5.77148ZM9.23111 9.46273C8.59507 9.46273 8.07762 8.94528 8.07762 8.30919C8.07762 7.67315 8.59507 7.1557 9.23111 7.1557C9.86715 7.1557 10.3847 7.67315 10.3847 8.30919C10.3846 8.94528 9.86715 9.46273 9.23111 9.46273Z"
                fill="#2AA952"
              />
              <path
                d="M14.7682 13.1543C13.3689 13.1543 12.2305 14.2927 12.2305 15.692C12.2305 17.0914 13.3689 18.2298 14.7682 18.2298C16.1675 18.2298 17.306 17.0914 17.306 15.692C17.306 14.2927 16.1675 13.1543 14.7682 13.1543ZM14.7682 16.8455C14.1322 16.8455 13.6147 16.3281 13.6147 15.692C13.6147 15.056 14.1321 14.5386 14.7682 14.5386C15.4043 14.5386 15.9217 15.056 15.9217 15.692C15.9217 16.3281 15.4043 16.8455 14.7682 16.8455Z"
                fill="#2AA952"
              />
            </g>
            <defs>
              <clipPath id="clip0_801_3480">
                <rect width="24" height="24" fill="white" />
              </clipPath>
            </defs>
          </svg>

          <input
            type="text"
            className="w-full px-4 py-[13.5px]  outline-none placeholder:font-archivo placeholder:text-sm placeholder:tracking-[1.08px] placeholder:text-[#8f8f8f] lg:py-[18px]  lg:placeholder:text-lg lg:placeholder:tracking-[1.62px]"
            placeholder="Coupon Name"
            value={couponCode}
            onChange={(event) => setCouponCode(event.target.value)}
          />
          <button
            className=" font-archivo text-sm tracking-[1.26px] text-primary lg:text-base lg:tracking-[2.16px] "
            onClick={handleCouponVerification}
          >
            Apply
          </button>
        </div>
      ) : (
        <>
          <div className="mb-5 flex w-full items-center justify-between rounded border border-primary/15 bg-white px-4 py-[13.5px] shadow-sm lg:py-[18px]">
            <div className="flex items-center gap-3">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                className="lg:h-9 lg:w-9"
              >
                <g clip-path="url(#clip0_801_3480)">
                  <path
                    d="M22.4039 12.3109C22.3074 12.1134 22.3074 11.8868 22.4039 11.6892L23.299 9.85808C23.7974 8.8385 23.4025 7.62328 22.4001 7.09139L20.5996 6.13608C20.4054 6.03305 20.2722 5.84968 20.2342 5.63316L19.8821 3.62557C19.686 2.50779 18.652 1.75667 17.5286 1.91562L15.5105 2.20109C15.2927 2.23184 15.0773 2.16181 14.9193 2.00895L13.4544 0.591834C12.6387 -0.197255 11.3609 -0.197302 10.5453 0.591834L9.08035 2.00909C8.92229 2.162 8.7069 2.23189 8.48912 2.20123L6.47102 1.91576C5.3472 1.75672 4.31361 2.50793 4.11753 3.62571L3.76541 5.63321C3.7274 5.84977 3.59422 6.0331 3.40002 6.13618L1.59956 7.09148C0.597101 7.62332 0.202228 8.83865 0.700601 9.85822L1.59567 11.6893C1.69224 11.8869 1.69224 12.1135 1.59567 12.311L0.700554 14.1421C0.202182 15.1617 0.597054 16.3769 1.59952 16.9088L3.39998 17.8641C3.59422 17.9672 3.7274 18.1505 3.76541 18.3671L4.11753 20.3747C4.29603 21.3922 5.16856 22.1058 6.17135 22.1057C6.27011 22.1057 6.37033 22.0988 6.47107 22.0846L8.48917 21.7991C8.7068 21.7682 8.92233 21.8384 9.0804 21.9912L10.5453 23.4083C10.9532 23.8029 11.4764 24.0002 11.9998 24.0001C12.5231 24.0001 13.0466 23.8028 13.4543 23.4083L14.9193 21.9912C15.0773 21.8384 15.2927 21.7685 15.5105 21.7991L17.5286 22.0846C18.6525 22.2436 19.686 21.4924 19.8821 20.3746L20.2342 18.3671C20.2723 18.1505 20.4054 17.9672 20.5996 17.8641L22.4001 16.9088C23.4025 16.377 23.7974 15.1617 23.299 14.1421L22.4039 12.3109ZM21.7513 15.686L19.9508 16.6413C19.3768 16.946 18.9831 17.4877 18.8708 18.1279L18.5187 20.1354C18.4524 20.5136 18.1027 20.7676 17.7225 20.7139L15.7044 20.4285C15.0608 20.3373 14.4239 20.5444 13.9568 20.9963L12.4919 22.4133C12.216 22.6802 11.7837 22.6802 11.5077 22.4133L10.0428 20.9962C9.648 20.6143 9.13191 20.4074 8.59313 20.4074C8.49442 20.4074 8.3949 20.4143 8.29524 20.4284L6.27715 20.7139C5.89718 20.7676 5.54726 20.5135 5.48089 20.1354L5.12872 18.1278C5.0164 17.4876 4.62275 16.9458 4.04867 16.6413L2.24822 15.686C1.90903 15.506 1.77544 15.0949 1.94405 14.7499L2.83917 12.9188C3.12454 12.3349 3.12454 11.6652 2.83917 11.0814L1.94405 9.25021C1.77544 8.90526 1.90903 8.49412 2.24822 8.31416L4.04867 7.35886C4.6227 7.05422 5.0164 6.51244 5.12867 5.87232L5.48079 3.86477C5.54717 3.48658 5.89676 3.23252 6.27705 3.28624L8.29515 3.57171C8.93851 3.66279 9.57558 3.45574 10.0427 3.00391L11.5076 1.5868C11.7835 1.31989 12.2158 1.31989 12.4918 1.5868L13.9567 3.00391C14.4238 3.45579 15.0608 3.66279 15.7043 3.57171L17.7224 3.28624C18.1024 3.23248 18.4523 3.48658 18.5186 3.86477L18.8707 5.87237C18.9831 6.51249 19.3767 7.05431 19.9508 7.35886L21.7512 8.31416C22.0904 8.49412 22.224 8.90526 22.0554 9.25021L21.1603 11.0813C20.8749 11.6651 20.8749 12.3349 21.1603 12.9187L22.0554 14.7498C22.2241 15.0949 22.0905 15.5061 21.7513 15.686Z"
                    fill="#2AA952"
                  />
                  <path
                    d="M17.0571 6.94294C16.7869 6.67266 16.3486 6.67266 16.0783 6.94294L6.94294 16.0784C6.67266 16.3486 6.67266 16.7869 6.94294 17.0571C7.07808 17.1923 7.25522 17.2599 7.43232 17.2599C7.60941 17.2599 7.7866 17.1923 7.92169 17.0571L17.0571 7.92178C17.3274 7.65146 17.3274 7.21327 17.0571 6.94294Z"
                    fill="#2AA952"
                  />
                  <path
                    d="M9.23111 5.77148C7.83181 5.77148 6.69336 6.90993 6.69336 8.30924C6.69336 9.70854 7.83181 10.847 9.23111 10.847C10.6304 10.847 11.7689 9.70854 11.7689 8.30924C11.7689 6.90993 10.6304 5.77148 9.23111 5.77148ZM9.23111 9.46273C8.59507 9.46273 8.07762 8.94528 8.07762 8.30919C8.07762 7.67315 8.59507 7.1557 9.23111 7.1557C9.86715 7.1557 10.3847 7.67315 10.3847 8.30919C10.3846 8.94528 9.86715 9.46273 9.23111 9.46273Z"
                    fill="#2AA952"
                  />
                  <path
                    d="M14.7682 13.1543C13.3689 13.1543 12.2305 14.2927 12.2305 15.692C12.2305 17.0914 13.3689 18.2298 14.7682 18.2298C16.1675 18.2298 17.306 17.0914 17.306 15.692C17.306 14.2927 16.1675 13.1543 14.7682 13.1543ZM14.7682 16.8455C14.1322 16.8455 13.6147 16.3281 13.6147 15.692C13.6147 15.056 14.1321 14.5386 14.7682 14.5386C15.4043 14.5386 15.9217 15.056 15.9217 15.692C15.9217 16.3281 15.4043 16.8455 14.7682 16.8455Z"
                    fill="#2AA952"
                  />
                </g>
                <defs>
                  <clipPath id="clip0_801_3480">
                    <rect width="24" height="24" fill="white" />
                  </clipPath>
                </defs>
              </svg>
              <b className="uppercase">{appliedCoupon}</b>
            </div>
            <button
              className=" font-archivo text-sm tracking-[1.26px] text-primary lg:text-2xl lg:tracking-[2.16px] "
              onClick={handleCouponChangeHandler}
            >
              Change
            </button>
          </div>
        </>
      )}
      {couponInfo.error && <p className="text-red-500">{couponInfo.error}</p>}
      {appliedCoupon && cart.discountInCent == 0 && (
        <p className="text-red-500">
          This coupon is not applicable to the products in the cart
        </p>
      )}
    </>
  );
}

export default ApplyCoupon;
